{% extends "base.html" %}

{% block title %}Match Review Module - {{ job.filename }}{% endblock %}

{% block content %}
<style>
    /* Import brutalist fonts */
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@300;400;500;600;700&display=swap');
    
    :root {
        /* Brutalist Color System */
        --primary-white: #FAFAFA;
        --structure-black: #1A1A1A;
        --accent-blue: #0066FF;
        --system-gray: #808080;
        --success-green: #00CC44;
        --warning-orange: #FF8800;
        --error-red: #FF3333;
        
        /* Brutalist Grid */
        --grid-gap: 16px;
        --border-width: 2px;
        --shadow-offset: 4px;
        
        /* Typography */
        --font-mono: 'JetBrains Mono', monospace;
        --font-sans: 'Inter', sans-serif;
    }
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: var(--font-sans);
        background: var(--primary-white);
        color: var(--structure-black);
        line-height: 1.4;
        min-height: 100vh;
    }
    
    /* Reset base styles for brutalist override */
    .card { display: none; }
    
    .brutalist-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: var(--grid-gap);
        min-height: 100vh;
        background: var(--primary-white);
    }
    
    /* Review Bento Grid Layout */
    .review-bento-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        grid-template-rows: auto;
        gap: var(--grid-gap);
        grid-template-areas:
            "header header header header header header stats stats stats stats stats stats"
            "controls controls controls controls filters filters filters filters filters filters filters filters"
            "entities entities entities entities entities entities entities entities entities entities entities entities"
            "pagination pagination pagination pagination pagination pagination pagination pagination pagination pagination pagination pagination";
    }
    
    /* Brutalist Block Foundation */
    .brutalist-block {
        background: var(--primary-white);
        border: var(--border-width) solid var(--structure-black);
        position: relative;
        transition: all 0.2s ease;
        padding: 24px;
    }
    
    .brutalist-block::before {
        content: '';
        position: absolute;
        top: var(--shadow-offset);
        left: var(--shadow-offset);
        right: calc(-1 * var(--shadow-offset));
        bottom: calc(-1 * var(--shadow-offset));
        background: var(--structure-black);
        z-index: -1;
    }
    
    .brutalist-block:hover::before {
        background: var(--accent-blue);
    }
    
    /* Header Block */
    .header-block {
        grid-area: header;
    }
    
    .system-title {
        font-family: var(--font-mono);
        font-size: clamp(24px, 5vw, 32px);
        font-weight: 700;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: var(--structure-black);
    }
    
    .job-subtitle {
        font-family: var(--font-mono);
        font-size: 11px;
        color: var(--system-gray);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0;
    }
    
    /* Stats Block */
    .stats-block {
        grid-area: stats;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-top: 16px;
    }
    
    .stat-card {
        background: var(--structure-black);
        color: var(--primary-white);
        padding: 16px;
        text-align: center;
        position: relative;
        border: var(--border-width) solid var(--structure-black);
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        right: -3px;
        bottom: -3px;
        background: var(--accent-blue);
        z-index: -1;
    }
    
    .stat-card.success::before { background: var(--success-green); }
    .stat-card.warning::before { background: var(--warning-orange); }
    .stat-card.error::before { background: var(--error-red); }
    
    .stat-value {
        font-family: var(--font-mono);
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 4px;
        color: var(--primary-white);
    }
    
    .stat-label {
        font-family: var(--font-mono);
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        opacity: 0.9;
    }
    
    /* Controls Block */
    .controls-block {
        grid-area: controls;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
    }
    
    .bulk-toggle {
        background: var(--system-gray);
        color: var(--primary-white);
        border: none;
        padding: 12px 16px;
        font-family: var(--font-mono);
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        cursor: pointer;
        position: relative;
    }
    
    .bulk-toggle::before {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        right: -3px;
        bottom: -3px;
        background: var(--structure-black);
        z-index: -1;
    }
    
    .bulk-toggle.active {
        background: var(--accent-blue);
    }
    
    /* Brutalist Buttons */
    .brutalist-btn {
        background: var(--structure-black);
        color: var(--primary-white);
        border: none;
        padding: 12px 16px;
        font-family: var(--font-mono);
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        cursor: pointer;
        position: relative;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        transition: all 0.1s ease;
    }
    
    .brutalist-btn::before {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        right: -3px;
        bottom: -3px;
        background: var(--system-gray);
        z-index: -1;
        transition: all 0.1s ease;
    }
    
    .brutalist-btn:hover::before {
        top: 2px;
        left: 2px;
        right: -2px;
        bottom: -2px;
        background: var(--accent-blue);
    }
    
    .brutalist-btn:active {
        transform: translate(2px, 2px);
    }
    
    .brutalist-btn:active::before {
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }
    
    .brutalist-btn.success { background: var(--success-green); }
    .brutalist-btn.warning { background: var(--warning-orange); }
    .brutalist-btn.error { background: var(--error-red); }
    .brutalist-btn.secondary {
        background: var(--primary-white);
        color: var(--structure-black);
        border: var(--border-width) solid var(--structure-black);
    }
    
    /* Filters Block */
    .filters-block {
        grid-area: filters;
    }
    
    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        margin-top: 16px;
    }
    
    .field-group {
        display: flex;
        flex-direction: column;
    }
    
    .field-label {
        font-family: var(--font-mono);
        font-size: 10px;
        font-weight: 600;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--structure-black);
    }
    
    .field-input, .field-select {
        padding: 12px;
        border: var(--border-width) solid var(--structure-black);
        background: var(--primary-white);
        font-family: var(--font-sans);
        font-size: 14px;
        font-weight: 400;
    }
    
    .field-input:focus, .field-select:focus {
        outline: none;
        border-color: var(--accent-blue);
    }
    
    /* Bulk Operations Panel */
    .bulk-operations {
        background: rgba(26, 26, 26, 0.05);
        padding: 20px;
        border: 2px dashed var(--system-gray);
        margin-bottom: var(--grid-gap);
        display: none;
        position: relative;
    }
    
    .bulk-operations.show {
        display: block;
        animation: slideDown 0.3s ease;
    }
    
    .bulk-header {
        font-family: var(--font-mono);
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 16px;
        color: var(--structure-black);
    }
    
    .bulk-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    /* Entities Container */
    .entities-container {
        grid-area: entities;
    }
    
    .entities-list {
        display: flex;
        flex-direction: column;
        gap: var(--grid-gap);
    }
    
    /* Entity Cards */
    .entity-card {
        border: var(--border-width) solid var(--structure-black);
        background: var(--primary-white);
        position: relative;
        transition: all 0.2s ease;
        overflow: hidden;
    }
    
    .entity-card::before {
        content: '';
        position: absolute;
        top: var(--shadow-offset);
        left: var(--shadow-offset);
        right: calc(-1 * var(--shadow-offset));
        bottom: calc(-1 * var(--shadow-offset));
        background: var(--system-gray);
        z-index: -1;
        transition: all 0.2s ease;
    }
    
    .entity-card:hover::before {
        background: var(--accent-blue);
        transform: translate(-2px, -2px);
    }
    
    .entity-card.selected {
        background: rgba(0, 102, 255, 0.1);
    }
    
    .entity-card.selected::before {
        background: var(--accent-blue);
    }
    
    /* Entity Header */
    .entity-header {
        background: var(--structure-black);
        color: var(--primary-white);
        padding: 16px;
        position: relative;
    }
    
    .entity-header-content {
        display: flex;
        justify-content: space-between;
        align-items: start;
    }
    
    .entity-select {
        margin-right: 12px;
        transform: scale(1.2);
    }
    
    .entity-name {
        font-family: var(--font-mono);
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        word-break: break-word;
    }
    
    .entity-meta {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        font-size: 11px;
        font-family: var(--font-mono);
        opacity: 0.9;
    }
    
    .meta-item {
        display: flex;
        gap: 4px;
        align-items: center;
    }
    
    .meta-label {
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .confidence-badge {
        display: inline-block;
        padding: 4px 8px;
        font-family: var(--font-mono);
        font-size: 9px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        border: 1px solid;
    }
    
    .confidence-badge.high {
        background: var(--success-green);
        color: var(--primary-white);
        border-color: var(--success-green);
    }
    
    .confidence-badge.medium {
        background: var(--warning-orange);
        color: var(--primary-white);
        border-color: var(--warning-orange);
    }
    
    .confidence-badge.low {
        background: var(--error-red);
        color: var(--primary-white);
        border-color: var(--error-red);
    }
    
    /* Entity Context */
    .entity-context {
        padding: 12px 16px;
        background: rgba(0, 102, 255, 0.05);
        border-bottom: 1px solid var(--system-gray);
        font-size: 12px;
    }
    
    .context-label {
        font-family: var(--font-mono);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
        font-size: 10px;
    }
    
    /* Matches Container */
    .matches-container {
        padding: 16px;
    }
    
    .matches-title {
        font-family: var(--font-mono);
        font-size: 14px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 16px;
        color: var(--structure-black);
    }
    
    .match-item {
        border: var(--border-width) solid var(--system-gray);
        margin-bottom: 12px;
        position: relative;
        background: var(--primary-white);
        transition: all 0.2s ease;
    }
    
    .match-item::before {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        right: -2px;
        bottom: -2px;
        background: var(--system-gray);
        z-index: -1;
        transition: all 0.2s ease;
    }
    
    .match-item:hover {
        border-color: var(--accent-blue);
    }
    
    .match-item:hover::before {
        background: var(--accent-blue);
    }
    
    .match-item.approved {
        border-color: var(--success-green);
        border-width: var(--border-width);
    }
    
    .match-item.approved::before {
        background: var(--success-green);
    }
    
    .match-item.rejected {
        border-color: var(--error-red);
        border-width: var(--border-width);
        opacity: 0.7;
    }
    
    .match-item.rejected::before {
        background: var(--error-red);
    }
    
    /* Match Header */
    .match-header {
        padding: 12px;
        display: flex;
        justify-content: space-between;
        align-items: start;
        background: rgba(128, 128, 128, 0.05);
        border-bottom: 1px solid var(--system-gray);
    }
    
    .match-info {
        flex: 1;
    }
    
    .match-name {
        font-family: var(--font-mono);
        font-size: 14px;
        font-weight: 700;
        margin-bottom: 4px;
        color: var(--structure-black);
    }
    
    .match-source {
        font-size: 10px;
        color: var(--system-gray);
        font-family: var(--font-mono);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .match-score {
        font-family: var(--font-mono);
        font-size: 16px;
        font-weight: 700;
        color: var(--accent-blue);
        text-align: right;
    }
    
    .match-score-label {
        font-family: var(--font-mono);
        font-size: 8px;
        color: var(--system-gray);
        text-transform: uppercase;
        margin-top: 2px;
    }
    
    /* Match Description */
    .match-description {
        padding: 12px;
        font-size: 12px;
        line-height: 1.4;
        border-bottom: 1px solid var(--system-gray);
        background: var(--primary-white);
    }
    
    /* Match Metadata */
    .match-metadata {
        padding: 12px;
        background: rgba(128, 128, 128, 0.05);
        border-bottom: 1px solid var(--system-gray);
    }
    
    .metadata-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 8px;
        font-size: 11px;
    }
    
    .metadata-item {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .metadata-label {
        font-family: var(--font-mono);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--system-gray);
        font-size: 9px;
    }
    
    .metadata-value {
        font-weight: 500;
        color: var(--structure-black);
    }
    
    /* Match Actions */
    .match-actions {
        padding: 12px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        background: var(--primary-white);
    }
    
    .action-btn {
        padding: 8px 12px;
        font-family: var(--font-mono);
        font-size: 9px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        border: none;
        cursor: pointer;
        position: relative;
        transition: all 0.1s ease;
        flex: 1;
        min-width: 80px;
    }
    
    .action-btn::before {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        right: -2px;
        bottom: -2px;
        z-index: -1;
        transition: all 0.1s ease;
    }
    
    .action-btn:hover::before {
        top: 1px;
        left: 1px;
        right: -1px;
        bottom: -1px;
    }
    
    .action-btn:active {
        transform: translate(1px, 1px);
    }
    
    .action-btn:active::before {
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }
    
    .action-btn.view {
        background: var(--system-gray);
        color: var(--primary-white);
    }
    
    .action-btn.view::before {
        background: var(--structure-black);
    }
    
    .action-btn.approve {
        background: var(--success-green);
        color: var(--primary-white);
    }
    
    .action-btn.approve::before {
        background: var(--structure-black);
    }
    
    .action-btn.reject {
        background: var(--error-red);
        color: var(--primary-white);
    }
    
    .action-btn.reject::before {
        background: var(--structure-black);
    }
    
    .action-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    /* No Matches State */
    .no-matches {
        text-align: center;
        padding: 40px 20px;
        color: var(--system-gray);
        font-family: var(--font-mono);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
        border: 2px dashed var(--system-gray);
        background: rgba(128, 128, 128, 0.05);
    }
    
    /* Pagination Block */
    .pagination-block {
        grid-area: pagination;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .pagination-info {
        font-family: var(--font-mono);
        font-size: 12px;
        color: var(--system-gray);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .pagination-controls {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .pagination-btn {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        font-size: 16px;
    }
    
    /* Status Messages */
    .status-message {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 16px;
        font-family: var(--font-mono);
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        border: var(--border-width) solid var(--structure-black);
        z-index: 1000;
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.3s ease;
    }
    
    .status-message.show {
        opacity: 1;
        transform: translateY(0);
    }
    
    .status-message.success {
        background: var(--success-green);
        color: var(--primary-white);
    }
    
    .status-message.error {
        background: var(--error-red);
        color: var(--primary-white);
    }
    
    .status-message.warning {
        background: var(--warning-orange);
        color: var(--primary-white);
    }
    
    .status-message::before {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        right: -2px;
        bottom: -2px;
        background: var(--structure-black);
        z-index: -1;
    }
    
    /* Animations */
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Responsive Design */
    @media (max-width: 1024px) {
        .review-bento-grid {
            grid-template-areas:
                "header header header header header header header header header header header header"
                "stats stats stats stats stats stats stats stats stats stats stats stats"
                "controls controls controls controls controls controls filters filters filters filters filters filters"
                "entities entities entities entities entities entities entities entities entities entities entities entities"
                "pagination pagination pagination pagination pagination pagination pagination pagination pagination pagination pagination pagination";
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .filters-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 768px) {
        .review-bento-grid {
            grid-template-columns: repeat(6, 1fr);
            grid-template-areas:
                "header header header header header header"
                "stats stats stats stats stats stats"
                "controls controls controls controls controls controls"
                "filters filters filters filters filters filters"
                "entities entities entities entities entities entities"
                "pagination pagination pagination pagination pagination pagination";
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .filters-grid {
            grid-template-columns: 1fr;
        }
        
        .controls-block {
            flex-direction: column;
            align-items: stretch;
        }
        
        .match-header {
            flex-direction: column;
            gap: 8px;
            align-items: start;
        }
        
        .metadata-grid {
            grid-template-columns: 1fr;
        }
        
        .match-actions {
            flex-direction: column;
        }
        
        .bulk-actions {
            flex-direction: column;
        }
    }
    
    @media (max-width: 480px) {
        .system-title {
            font-size: 20px;
        }
        
        .entity-name {
            font-size: 16px;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }
    
    /* High contrast mode */
    @media (prefers-contrast: high) {
        :root {
            --primary-white: #FFFFFF;
            --structure-black: #000000;
            --system-gray: #666666;
            --accent-blue: #0033CC;
        }
    }
    
    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
        * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
    }
</style>

<div class="brutalist-container">
    <div class="review-bento-grid">
        <!-- Header Block -->
        <div class="brutalist-block header-block">
            <h1 class="system-title">Match Review Module</h1>
            <p class="job-subtitle">Job: {{ job.filename }} | Status: Review_Phase</p>
        </div>
        
        <!-- Stats Block -->
        <div class="brutalist-block stats-block">
            <h2 class="field-label">Review Statistics</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">{{ (results | length) if results else 0 }}</div>
                    <div class="stat-label">Total Entities</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value" id="approved-count">0</div>
                    <div class="stat-label">Approved</div>
                </div>
                <div class="stat-card error">
                    <div class="stat-value" id="rejected-count">0</div>
                    <div class="stat-label">Rejected</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="pending-count">{{ (results | length) if results else 0 }}</div>
                    <div class="stat-label">Pending</div>
                </div>
            </div>
        </div>
        
        <!-- Controls Block -->
        <div class="brutalist-block controls-block">
            <button class="bulk-toggle" onclick="toggleBulkOperations()" id="bulk-toggle">
                BULK OPERATIONS
            </button>
            
            <button class="brutalist-btn success" onclick="batchApproveHighConfidence()">
                APPROVE HIGH CONFIDENCE
            </button>
            
            <button class="brutalist-btn secondary" onclick="exportCurrentView()">
                EXPORT VIEW
            </button>
            
            <a href="{{ url_for('export', job_id=job.id) }}" class="brutalist-btn">
                PROCEED TO EXPORT
            </a>
            
            <a href="/jobs" class="brutalist-btn secondary">
                BACK TO JOBS
            </a>
        </div>
        
        <!-- Filters Block -->
        <div class="brutalist-block filters-block">
            <h2 class="field-label">Filter & Search</h2>
            <div class="filters-grid">
                <div class="field-group">
                    <label class="field-label">Search Entities</label>
                    <input type="text" class="field-input" id="entity-search" placeholder="Search entity names..." onkeyup="filterEntities()">
                </div>
                
                <div class="field-group">
                    <label class="field-label">Min Confidence</label>
                    <select class="field-select" id="confidence-filter" onchange="filterEntities()">
                        <option value="0">All Confidence Levels</option>
                        <option value="0.7">Medium+ (0.7)</option>
                        <option value="0.8">High+ (0.8)</option>
                        <option value="0.9">Very High+ (0.9)</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label class="field-label">Source Authority</label>
                    <select class="field-select" id="source-filter" onchange="filterEntities()">
                        <option value="">All Sources</option>
                        <option value="wikidata">Wikidata</option>
                        <option value="viaf">VIAF</option>
                        <option value="getty">Getty</option>
                        <option value="loc">Library of Congress</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label class="field-label">Review Status</label>
                    <select class="field-select" id="approval-filter" onchange="filterEntities()">
                        <option value="">All Matches</option>
                        <option value="approved">Approved Only</option>
                        <option value="rejected">Rejected Only</option>
                        <option value="pending">Pending Review</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Entities Container -->
        <div class="brutalist-block entities-container">
            <!-- Bulk Operations Panel -->
            <div class="bulk-operations" id="bulk-operations">
                <div class="bulk-header">
                    <span id="selected-count">0</span> ENTITIES SELECTED
                </div>
                <div class="bulk-actions">
                    <button class="brutalist-btn success" onclick="approveSelected()">APPROVE SELECTED</button>
                    <button class="brutalist-btn error" onclick="rejectSelected()">REJECT SELECTED</button>
                    <button class="brutalist-btn secondary" onclick="clearSelections()">CLEAR SELECTION</button>
                </div>
            </div>
            
            <!-- Entities List -->
            <div class="entities-list" id="entities-list">
                {% if results %}
                {% for result in results %}
                <div class="entity-card" 
                     data-entity-id="{{ result.entity.id }}" 
                     data-confidence="{{ 'high' if result.highest_confidence > 0.8 else 'medium' if result.highest_confidence > 0.6 else 'low' }}">
                    
                    <!-- Entity Header -->
                    <div class="entity-header">
                        <div class="entity-header-content">
                            <div style="display: flex; align-items: start;">
                                <input type="checkbox" class="entity-select" value="{{ result.entity.id }}" onchange="updateSelection()">
                                <div>
                                    <div class="entity-name">{{ result.entity.name }}</div>
                                    <div class="entity-meta">
                                        <div class="meta-item">
                                            <span class="meta-label">Type:</span>
                                            <span>{{ result.entity.type or 'Unknown' }}</span>
                                        </div>
                                        <div class="meta-item">
                                            <span class="meta-label">Matches:</span>
                                            <span>{{ result.matches | length }}</span>
                                        </div>
                                        <div class="meta-item">
                                            <span class="meta-label">Best:</span>
                                            <span class="confidence-badge {{ 'high' if result.highest_confidence > 0.8 else 'medium' if result.highest_confidence > 0.6 else 'low' }}">
                                                {{ "%.3f" | format(result.highest_confidence) }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Entity Context (if available) -->
                    {% if result.entity.context %}
                    <div class="entity-context">
                        <div class="context-label">Context Information</div>
                        <div>{{ result.entity.context }}</div>
                    </div>
                    {% endif %}
                    
                    <!-- Matches Container -->
                    <div class="matches-container">
                        <h3 class="matches-title">Authority Matches ({{ result.matches | length }})</h3>
                        
                        {% if result.matches %}
                            {% for match in result.matches[:5] %}
                            <div class="match-item" data-match-id="{{ match.id }}">
                                <!-- Match Header -->
                                <div class="match-header">
                                    <div class="match-info">
                                        <div class="match-name">{{ match.name }}</div>
                                        <div class="match-source">{{ match.source | upper }} | ID: {{ match.id }}</div>
                                    </div>
                                    <div>
                                        <div class="match-score">{{ "%.3f" | format(match.score) }}</div>
                                        <div class="match-score-label">Confidence</div>
                                    </div>
                                </div>
                                
                                <!-- Match Description -->
                                {% if match.description %}
                                <div class="match-description">{{ match.description }}</div>
                                {% endif %}
                                
                                <!-- Match Metadata -->
                                {% if match.additional_info %}
                                <div class="match-metadata">
                                    <div class="metadata-grid">
                                        {% for key, value in match.additional_info.items() %}
                                            {% if key not in ['uri', 'scope_note'] and value and key != 'search_method' %}
                                            <div class="metadata-item">
                                                <span class="metadata-label">{{ key | replace('_', ' ') | title }}</span>
                                                <span class="metadata-value">{{ value }}</span>
                                            </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Match Actions -->
                                <div class="match-actions">
                                    <button class="action-btn view" onclick="viewMatchDetails('{{ match.id | e }}', '{{ match.source | e }}')">
                                        VIEW DETAILS
                                    </button>
                                    <button class="action-btn approve" onclick="approveMatch('{{ result.entity.id | e }}', '{{ match.id | e }}', true)">
                                        ✓ APPROVE
                                    </button>
                                    <button class="action-btn reject" onclick="approveMatch('{{ result.entity.id | e }}', '{{ match.id | e }}', false)">
                                        ✗ REJECT
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                            
                            {% if result.matches | length > 5 %}
                            <div class="no-matches" style="padding: 12px; font-size: 10px;">
                                ... and {{ result.matches | length - 5 }} more matches available
                            </div>
                            {% endif %}
                        {% else %}
                            <div class="no-matches">
                                No authority matches found for this entity
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="no-matches">
                    No entities to review
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Pagination Block -->
        <div class="brutalist-block pagination-block">
            <div class="pagination-info">
                {% if pagination and results %}
                Showing {{ ((pagination.page - 1) * pagination.per_page + 1) if results else 0 }}-{{ pagination.page * pagination.per_page if pagination.page * pagination.per_page < pagination.total else pagination.total }} of {{ pagination.total }} entities
                {% else %}
                No pagination information available
                {% endif %}
            </div>
            <div class="pagination-controls">
                {% if pagination %}
                    {% if pagination.has_prev %}
                        <a href="{{ url_for('review', job_id=job.id, page=pagination.prev_num) }}" class="brutalist-btn pagination-btn">‹</a>
                    {% else %}
                        <button class="brutalist-btn pagination-btn" disabled>‹</button>
                    {% endif %}
                    
                    <span class="pagination-info">Page {{ pagination.page }} of {{ pagination.pages }}</span>
                    
                    {% if pagination.has_next %}
                        <a href="{{ url_for('review', job_id=job.id, page=pagination.next_num) }}" class="brutalist-btn pagination-btn">›</a>
                    {% else %}
                        <button class="brutalist-btn pagination-btn" disabled>›</button>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Status Messages Container -->
<div id="status-messages"></div>

<!-- Template Data for JavaScript (Properly Escaped) -->
<script type="application/json" id="template-data">
{
    "totalEntities": {{ (results | length) if results else 0 }},
    "jobId": {{ job.id | tojson }},
    "csrfToken": "{{ csrf_token() if csrf_token is defined else '' }}"
}
</script>

<script>
    class ReviewManager {
        constructor() {
            this.selectedEntities = new Set();
            this.approvedCount = 0;
            this.rejectedCount = 0;
            
            // Get template data safely
            try {
                const templateData = JSON.parse(document.getElementById('template-data').textContent);
                this.pendingCount = templateData.totalEntities || 0;
                this.jobId = templateData.jobId;
                this.csrfToken = templateData.csrfToken;
            } catch (e) {
                console.warn('Could not parse template data:', e);
                this.pendingCount = 0;
                this.jobId = null;
                this.csrfToken = '';
            }
            
            this.setupEventListeners();
            this.setupKeyboardShortcuts();
            this.updateStats();
        }
        
        setupEventListeners() {
            // Entity selection checkboxes
            document.addEventListener('change', (e) => {
                if (e.target.classList.contains('entity-select')) {
                    this.updateSelection();
                }
            });
            
            // Real-time search
            const searchInput = document.getElementById('entity-search');
            if (searchInput) {
                searchInput.addEventListener('input', () => this.filterEntities());
            }
        }
        
        setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'a':
                            e.preventDefault();
                            this.selectAllEntities();
                            break;
                        case 'f':
                            e.preventDefault();
                            const searchField = document.getElementById('entity-search');
                            if (searchField) searchField.focus();
                            break;
                        case 'b':
                            e.preventDefault();
                            this.toggleBulkOperations();
                            break;
                    }
                }
            });
        }
        
        updateSelection() {
            const checkboxes = document.querySelectorAll('.entity-select');
            const bulkOps = document.getElementById('bulk-operations');
            const selectedCount = document.getElementById('selected-count');
            
            this.selectedEntities.clear();
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    this.selectedEntities.add(cb.value);
                    const card = cb.closest('.entity-card');
                    if (card) card.classList.add('selected');
                } else {
                    const card = cb.closest('.entity-card');
                    if (card) card.classList.remove('selected');
                }
            });
            
            if (selectedCount) {
                selectedCount.textContent = this.selectedEntities.size;
            }
            
            if (this.selectedEntities.size > 0 && bulkOps) {
                bulkOps.classList.add('show');
            } else if (bulkOps) {
                bulkOps.classList.remove('show');
            }
        }
        
        selectAllEntities() {
            const checkboxes = document.querySelectorAll('.entity-select:not(:disabled)');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
            });
            
            this.updateSelection();
        }
        
        clearSelections() {
            document.querySelectorAll('.entity-select').forEach(cb => {
                cb.checked = false;
            });
            this.updateSelection();
        }
        
        toggleBulkOperations() {
            const bulkOps = document.getElementById('bulk-operations');
            const toggle = document.getElementById('bulk-toggle');
            
            if (bulkOps) bulkOps.classList.toggle('show');
            if (toggle) toggle.classList.toggle('active');
        }
        
        filterEntities() {
            const searchInput = document.getElementById('entity-search');
            const confidenceFilter = document.getElementById('confidence-filter');
            const sourceFilter = document.getElementById('source-filter');
            const approvalFilter = document.getElementById('approval-filter');
            
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const minConfidence = confidenceFilter ? parseFloat(confidenceFilter.value) || 0 : 0;
            const sourceValue = sourceFilter ? sourceFilter.value : '';
            const approvalValue = approvalFilter ? approvalFilter.value : '';
            
            const entityCards = document.querySelectorAll('.entity-card');
            let visibleCount = 0;
            
            entityCards.forEach(card => {
                const entityNameEl = card.querySelector('.entity-name');
                const confidenceBadge = card.querySelector('.confidence-badge');
                
                if (!entityNameEl) return;
                
                const entityName = entityNameEl.textContent.toLowerCase();
                const confidence = confidenceBadge ? parseFloat(confidenceBadge.textContent) : 0;
                
                let shouldShow = true;
                
                // Text search
                if (searchTerm && !entityName.includes(searchTerm)) {
                    shouldShow = false;
                }
                
                // Confidence filter
                if (confidence < minConfidence) {
                    shouldShow = false;
                }
                
                // Source filter
                if (sourceValue) {
                    const metaEl = card.querySelector('.entity-meta');
                    const sources = metaEl ? metaEl.textContent.toLowerCase() : '';
                    if (!sources.includes(sourceValue.toLowerCase())) {
                        shouldShow = false;
                    }
                }
                
                // Approval filter
                if (approvalValue) {
                    const matches = card.querySelectorAll('.match-item');
                    let hasApprovalStatus = false;
                    
                    matches.forEach(match => {
                        if (approvalValue === 'approved' && match.classList.contains('approved')) {
                            hasApprovalStatus = true;
                        } else if (approvalValue === 'rejected' && match.classList.contains('rejected')) {
                            hasApprovalStatus = true;
                        } else if (approvalValue === 'pending' && !match.classList.contains('approved') && !match.classList.contains('rejected')) {
                            hasApprovalStatus = true;
                        }
                    });
                    
                    if (!hasApprovalStatus) {
                        shouldShow = false;
                    }
                }
                
                card.style.display = shouldShow ? 'block' : 'none';
                if (shouldShow) visibleCount++;
            });
            
            console.log(`📊 Showing ${visibleCount} of ${entityCards.length} entities`);
        }
        
        approveMatch(entityId, matchId, approve) {
            const matchCard = document.querySelector(`[data-match-id="${matchId}"]`);
            if (!matchCard) return;
            
            const approveBtn = matchCard.querySelector('.approve');
            const rejectBtn = matchCard.querySelector('.reject');
            
            // Disable buttons during request
            if (approveBtn) approveBtn.disabled = true;
            if (rejectBtn) rejectBtn.disabled = true;
            
            this.showLoading(matchCard);
            
            const requestData = {
                entity_id: entityId,
                approved: approve,
                job_id: window.currentJobId
            };
            
            // Add CSRF token if available
            if (this.csrfToken) {
                requestData.csrf_token = this.csrfToken;
            }
            
            fetch(`/api/matches/${encodeURIComponent(matchId)}/approve`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update match styling
                    matchCard.classList.remove('approved', 'rejected');
                    matchCard.classList.add(approve ? 'approved' : 'rejected');
                    
                    // Update stats
                    if (approve) {
                        this.approvedCount++;
                        if (this.pendingCount > 0) this.pendingCount--;
                    } else {
                        this.rejectedCount++;
                        if (this.pendingCount > 0) this.pendingCount--;
                    }
                    
                    this.updateStats();
                    this.showStatusMessage(`Match ${approve ? 'approved' : 'rejected'} successfully`, 'success');
                } else {
                    this.showStatusMessage('Error updating match: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.showStatusMessage('Network error updating match', 'error');
            })
            .finally(() => {
                // Re-enable buttons
                if (approveBtn) approveBtn.disabled = false;
                if (rejectBtn) rejectBtn.disabled = false;
                this.hideLoading(matchCard);
            });
        }
        
        viewMatchDetails(matchId, source) {
            if (!matchId || !source) {
                this.showStatusMessage('Invalid match information', 'error');
                return;
            }
            
            let url;
            const sourceType = source.toLowerCase();
            
            switch(sourceType) {
                case 'wikidata':
                    url = `https://www.wikidata.org/entity/${encodeURIComponent(matchId)}`;
                    break;
                case 'viaf':
                    url = `https://viaf.org/viaf/${encodeURIComponent(matchId)}`;
                    break;
                case 'getty':
                    url = `http://vocab.getty.edu/page/${encodeURIComponent(matchId)}`;
                    break;
                default:
                    this.showStatusMessage('Unknown source: ' + source, 'error');
                    return;
            }
            
            window.open(url, '_blank');
        }
        
        batchApproveHighConfidence() {
            const highConfidenceMatches = document.querySelectorAll('[data-confidence="high"] .match-item .approve');
            const confirmMsg = `This will approve ${highConfidenceMatches.length} high-confidence matches. Continue?`;
            
            if (highConfidenceMatches.length === 0) {
                this.showStatusMessage('No high-confidence matches found', 'warning');
                return;
            }
            
            if (confirm(confirmMsg)) {
                let processed = 0;
                const total = highConfidenceMatches.length;
                
                this.showStatusMessage(`Starting batch approval of ${total} matches...`, 'warning');
                
                highConfidenceMatches.forEach((btn, index) => {
                    setTimeout(() => {
                        if (btn && !btn.disabled) {
                            btn.click();
                            processed++;
                            if (processed === total) {
                                this.showStatusMessage(`Batch approval complete: ${total} matches processed`, 'success');
                            }
                        }
                    }, index * 200); // Stagger requests
                });
            }
        }
        
        approveSelected() {
            if (this.selectedEntities.size === 0) {
                this.showStatusMessage('No entities selected', 'error');
                return;
            }
            
            const confirmMsg = `Approve first match for ${this.selectedEntities.size} selected entities?`;
            if (confirm(confirmMsg)) {
                this.selectedEntities.forEach(entityId => {
                    const entity = document.querySelector(`[data-entity-id="${entityId}"]`);
                    const firstApproveBtn = entity ? entity.querySelector('.approve') : null;
                    if (firstApproveBtn && !firstApproveBtn.disabled) {
                        firstApproveBtn.click();
                    }
                });
                this.clearSelections();
            }
        }
        
        rejectSelected() {
            if (this.selectedEntities.size === 0) {
                this.showStatusMessage('No entities selected', 'error');
                return;
            }
            
            const confirmMsg = `Reject all matches for ${this.selectedEntities.size} selected entities?`;
            if (confirm(confirmMsg)) {
                this.selectedEntities.forEach(entityId => {
                    const entity = document.querySelector(`[data-entity-id="${entityId}"]`);
                    if (entity) {
                        const rejectBtns = entity.querySelectorAll('.reject');
                        rejectBtns.forEach(btn => {
                            if (!btn.disabled) btn.click();
                        });
                    }
                });
                this.clearSelections();
            }
        }
        
        exportCurrentView() {
            this.showStatusMessage('Export functionality would be implemented here', 'warning');
        }
        
        updateStats() {
            const approvedEl = document.getElementById('approved-count');
            const rejectedEl = document.getElementById('rejected-count');
            const pendingEl = document.getElementById('pending-count');
            
            if (approvedEl) approvedEl.textContent = this.approvedCount;
            if (rejectedEl) rejectedEl.textContent = this.rejectedCount;
            if (pendingEl) pendingEl.textContent = this.pendingCount;
        }
        
        showLoading(element) {
            if (element) {
                element.style.opacity = '0.6';
                element.style.pointerEvents = 'none';
            }
        }
        
        hideLoading(element) {
            if (element) {
                element.style.opacity = '1';
                element.style.pointerEvents = 'auto';
            }
        }
        
        showStatusMessage(message, type = 'success') {
            const container = document.getElementById('status-messages');
            if (!container) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `status-message ${type}`;
            messageDiv.textContent = message;
            
            container.appendChild(messageDiv);
            
            // Show message
            setTimeout(() => messageDiv.classList.add('show'), 100);
            
            // Hide and remove message
            setTimeout(() => {
                messageDiv.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(messageDiv)) {
                        container.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
        }
    }
    
    // Initialize review manager
    let reviewManager;
    document.addEventListener('DOMContentLoaded', function() {
        reviewManager = new ReviewManager();
    });
    
    // Global functions for template compatibility
    function updateSelection() { 
        if (reviewManager) reviewManager.updateSelection(); 
    }
    function selectAllEntities() { 
        if (reviewManager) reviewManager.selectAllEntities(); 
    }
    function clearSelections() { 
        if (reviewManager) reviewManager.clearSelections(); 
    }
    function toggleBulkOperations() { 
        if (reviewManager) reviewManager.toggleBulkOperations(); 
    }
    function filterEntities() { 
        if (reviewManager) reviewManager.filterEntities(); 
    }
    function approveMatch(entityId, matchId, approve) { 
        if (reviewManager) reviewManager.approveMatch(entityId, matchId, approve); 
    }
    function viewMatchDetails(matchId, source) { 
        if (reviewManager) reviewManager.viewMatchDetails(matchId, source); 
    }
    function batchApproveHighConfidence() { 
        if (reviewManager) reviewManager.batchApproveHighConfidence(); 
    }
    function approveSelected() { 
        if (reviewManager) reviewManager.approveSelected(); 
    }
    function rejectSelected() { 
        if (reviewManager) reviewManager.rejectSelected(); 
    }
    function exportCurrentView() { 
        if (reviewManager) reviewManager.exportCurrentView(); 
    }
</script>

<script>
window.currentJobId = "{{ job.id }}";  // Make job ID available to JavaScript
</script>

{% endblock %}