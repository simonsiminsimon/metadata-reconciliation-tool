{% extends "base.html" %}

{% block title %}Metadata Reconciliation - Upload{% endblock %}

{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@300;400;500;600;700&display=swap');
    
    :root {
        /* Brutalist Color Palette - 4 colors max */
        --primary-white: #FAFAFA;
        --structure-black: #1A1A1A;
        --accent-blue: #0066FF;
        --system-gray: #808080;
        
        /* Grid System */
        --grid-gap: 16px;
        --border-width: 2px;
        --border-radius: 0px;
        
        /* Typography */
        --font-mono: 'JetBrains Mono', monospace;
        --font-sans: 'Inter', sans-serif;
    }
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: var(--font-sans);
        background: var(--primary-white);
        color: var(--structure-black);
        line-height: 1.4;
        min-height: 100vh;
    }
    
    /* Hide base template styling */
    .card {
        display: none;
    }
    
    /* Brutalist Container */
    .brutalist-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: var(--grid-gap);
        min-height: 100vh;
    }
    
    /* Bento Grid System */
    .bento-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        grid-template-rows: auto;
        gap: var(--grid-gap);
        grid-template-areas:
            "header header header header header header header header header status status status"
            "upload upload upload upload upload upload config config config config config config"
            "features features features features features features features features features features features features"
            "controls controls controls controls controls controls controls controls controls controls controls controls";
    }
    
    /* Brutalist Block Base */
    .brutalist-block {
        background: var(--primary-white);
        border: var(--border-width) solid var(--structure-black);
        padding: 24px;
        position: relative;
        transition: none;
    }
    
    .brutalist-block::before {
        content: '';
        position: absolute;
        top: 4px;
        left: 4px;
        right: -4px;
        bottom: -4px;
        background: var(--structure-black);
        z-index: -1;
    }
    
    /* Header Block */
    .header-block {
        grid-area: header;
    }
    
    .system-title {
        font-family: var(--font-mono);
        font-size: clamp(18px, 3vw, 24px);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
    }
    
    .system-subtitle {
        font-size: 14px;
        color: var(--system-gray);
        line-height: 1.4;
    }
    
    /* Status Block */
    .status-block {
        grid-area: status;
        background: var(--primary-white);
        min-height: 140px;
    }
    
    .status-indicator {
        font-family: var(--font-mono);
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 16px;
    }
    
    .status-details {
        font-family: var(--font-mono);
        font-size: 9px;
        color: var(--system-gray);
        line-height: 2.2;
        white-space: pre-line;
        overflow: visible;
    }
    
    /* Upload Block */
    .upload-block {
        grid-area: upload;
    }
    
    .upload-title {
        font-family: var(--font-mono);
        font-size: 14px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 16px;
    }
    
    .upload-zone {
        border: var(--border-width) dashed var(--system-gray);
        padding: 48px 24px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        background: rgba(128, 128, 128, 0.02);
        display: block;
        width: 100%;
        box-sizing: border-box;
    }
    
    .upload-zone:hover {
        border-color: var(--accent-blue);
        background: rgba(0, 102, 255, 0.02);
    }
    
    .upload-zone.active {
        border-color: var(--accent-blue);
        background: rgba(0, 102, 255, 0.05);
    }
    
    .upload-icon {
        font-family: var(--font-mono);
        font-size: 32px;
        display: block;
        margin-bottom: 8px;
    }
    
    .upload-text {
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 4px;
    }
    
    .upload-hint {
        font-size: 11px;
        color: var(--system-gray);
    }
    
    /* Configuration Block */
    .config-block {
        grid-area: config;
    }
    
    .config-title {
        font-family: var(--font-mono);
        font-size: 14px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 16px;
    }
    
    .config-section {
        margin-bottom: 16px;
    }
    
    .config-section:last-child {
        margin-bottom: 0;
    }
    
    .field-label {
        display: block;
        font-size: 12px;
        font-weight: 500;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--structure-black);
    }
    
    .field-input, .field-select {
        width: 100%;
        padding: 12px;
        border: var(--border-width) solid var(--structure-black);
        background: var(--primary-white);
        font-family: var(--font-sans);
        font-size: 14px;
        font-weight: 400;
        border-radius: 0;
    }
    
    .field-input:focus, .field-select:focus {
        outline: none;
        border-color: var(--accent-blue);
    }
    
    .field-help {
        font-size: 11px;
        color: var(--system-gray);
        margin-top: 4px;
        font-family: var(--font-mono);
    }
    
    /* Column Detection Status */
    .column-status {
        margin-top: 8px;
        padding: 8px;
        background: rgba(0, 102, 255, 0.05);
        border: 1px solid var(--accent-blue);
        font-family: var(--font-mono);
        font-size: 10px;
        color: var(--accent-blue);
    }
    
    .column-status.hidden {
        display: none;
    }
    
    /* Features Block */
    .features-block {
        grid-area: features;
    }
    
    .features-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--grid-gap);
    }
    
    .feature-item {
        padding: 16px;
        border: 1px solid var(--system-gray);
        text-align: center;
        position: relative;
        cursor: pointer;
        transition: all 0.15s ease;
        background: var(--primary-white);
    }
    
    .feature-item::before {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        right: -2px;
        bottom: -2px;
        background: transparent;
        z-index: -1;
        transition: all 0.15s ease;
    }
    
    .feature-item:hover {
        border-color: var(--accent-blue);
        transform: translate(-1px, -1px);
    }
    
    .feature-item:hover::before {
        background: var(--accent-blue);
        opacity: 0.1;
    }
    
    .feature-item:hover .feature-icon {
        color: var(--accent-blue);
    }
    
    .feature-item:hover .feature-name {
        color: var(--accent-blue);
    }
    
    .feature-icon {
        font-family: var(--font-mono);
        font-size: 24px;
        margin-bottom: 8px;
        display: block;
        transition: color 0.15s ease;
    }
    
    .feature-name {
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
        transition: color 0.15s ease;
    }
    
    .feature-desc {
        font-size: 10px;
        color: var(--system-gray);
        line-height: 1.3;
    }
    
    /* Controls Block */
    .controls-block {
        grid-area: controls;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: var(--grid-gap);
    }
    
    .control-group {
        display: flex;
        gap: var(--grid-gap);
        align-items: center;
    }
    
    /* Brutalist Buttons */
    .brutalist-btn {
        background: var(--structure-black);
        color: var(--primary-white);
        border: none;
        padding: 16px 24px;
        font-family: var(--font-mono);
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 1px;
        cursor: pointer;
        position: relative;
        text-decoration: none;
        display: inline-block;
    }
    
    .brutalist-btn::before {
        content: '';
        position: absolute;
        top: 4px;
        left: 4px;
        right: -4px;
        bottom: -4px;
        background: var(--accent-blue);
        z-index: -1;
        transition: all 0.1s ease;
    }
    
    .brutalist-btn:hover::before {
        top: 2px;
        left: 2px;
        right: -2px;
        bottom: -2px;
    }
    
    .brutalist-btn:active {
        transform: translate(2px, 2px);
    }
    
    .brutalist-btn:active::before {
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }
    
    .brutalist-btn.secondary {
        background: var(--primary-white);
        color: var(--structure-black);
        border: var(--border-width) solid var(--structure-black);
    }
    
    .brutalist-btn.secondary::before {
        background: var(--system-gray);
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .bento-grid {
            grid-template-columns: 1fr;
            grid-template-areas:
                "header"
                "status"
                "upload"
                "config"
                "features"
                "controls";
        }
        
        .status-block {
            min-height: 100px;
        }
        
        .status-details {
            white-space: normal;
        }
        
        .features-grid {
            grid-template-columns: 1fr;
        }
        
        .controls-block {
            flex-direction: column;
        }
    }
</style>

<div class="brutalist-container">
    <!-- IMPORTANT: This form now wraps ALL inputs -->
    <form method="POST" enctype="multipart/form-data" id="upload-form">
        <!-- Main Bento Grid -->
        <div class="bento-grid" id="main-grid">
            <!-- Header Block -->
            <div class="brutalist-block header-block">
                <h1 class="system-title">Metadata Reconciliation System</h1>
                <p class="system-subtitle">Entity linking and authority control processing interface</p>
            </div>
            
            <!-- Status Block -->
            <div class="brutalist-block status-block">
                <div class="status-indicator">System Status</div>
                <div class="status-details">
                    SPARQL_ENDPOINT: ACTIVE<br>
                    WIKIDATA_API: READY<br>
                    PROCESSING_QUEUE: <span id="queue-count">0</span>
                </div>
            </div>
            
            <!-- Upload Block -->
            <div class="brutalist-block upload-block">
                <h2 class="upload-title">Data Input</h2>
                <label for="file-input" class="upload-zone">
                    <span class="upload-icon">▦</span>
                    <div class="upload-text">Select metadata file</div>
                    <div class="upload-hint">CSV, XLSX • MAX 50MB</div>
                </label>
                <input type="file" id="file-input" name="file" accept=".csv,.xlsx,.xls" style="display: none;" required>
            </div>
            
            <!-- Configuration Block -->
            <div class="brutalist-block config-block">
                <h2 class="config-title">Processing Parameters</h2>
                
                <div class="config-section">
                    <label class="field-label" for="entity_column">Entity Column [REQUIRED]</label>
                    <select id="entity_column" name="entity_column" class="field-select" required>
                        <option value="">Select column containing entity names...</option>
                        <option value="creator_name">creator_name</option>
                        <option value="author">author</option>
                        <option value="artist">artist</option>
                        <option value="name">name</option>
                        <option value="title">title</option>
                    </select>
                    <div class="field-help">COLUMN_CONTAINING_NAMES_TO_RECONCILE → PERSONS/ORGS/PLACES</div>
                    <div class="column-status hidden" id="entity-status"></div>
                </div>
                
                <div class="config-section">
                    <label class="field-label" for="type_column">Type Column [OPTIONAL]</label>
                    <select id="type_column" name="type_column" class="field-select">
                        <option value="">Auto-detect entity types</option>
                        <option value="entity_type">entity_type</option>
                        <option value="type">type</option>
                        <option value="category">category</option>
                    </select>
                    <div class="field-help">ENTITY_CLASSIFICATION_COLUMN → IMPROVES_MATCHING_ACCURACY</div>
                    <div class="column-status hidden" id="type-status"></div>
                </div>
                
                <div class="config-section">
                    <label class="field-label" for="context_columns">Context Columns [OPTIONAL]</label>
                    <input type="text" id="context_columns" name="context_columns" class="field-input" 
                           placeholder="date_created,location,nationality">
                    <div class="field-help">COMMA_SEPARATED_CONTEXT_FIELDS → DATES/PLACES/ROLES_FOR_DISAMBIGUATION</div>
                    <div class="column-status hidden" id="context-status"></div>
                </div>
                
                <div class="config-section">
                    <label class="field-label" for="confidence_threshold">Confidence Threshold [DEFAULT]</label>
                    <select id="confidence_threshold" name="confidence_threshold" class="field-select">
                        <option value="0.8">HIGH_PRECISION (0.8)</option>
                        <option value="0.6" selected>BALANCED (0.6)</option>
                        <option value="0.4">BROAD_MATCH (0.4)</option>
                    </select>
                    <div class="field-help">MATCHING_PRECISION_THRESHOLD → HIGHER_VALUES_REQUIRE_EXACT_MATCHES</div>
                </div>
                
                <div class="config-section">
                    <label class="field-label" for="data_sources">Data Sources [MULTIPLE]</label>
                    <div style="margin-top: 8px;">
                        <label style="display: block; margin-bottom: 4px; font-size: 11px; text-transform: none;">
                            <input type="checkbox" name="data_sources" value="wikidata" checked style="margin-right: 8px;">
                            WIKIDATA → COMPREHENSIVE_ENTITY_DATABASE
                        </label>
                        <label style="display: block; margin-bottom: 4px; font-size: 11px; text-transform: none;">
                            <input type="checkbox" name="data_sources" value="viaf" checked style="margin-right: 8px;">
                            VIAF → AUTHORITY_NAMES_LIBRARY_OF_CONGRESS
                        </label>
                        <label style="display: block; font-size: 11px; text-transform: none;">
                            <input type="checkbox" name="data_sources" value="getty" style="margin-right: 8px;">
                            GETTY → ART_&_ARCHITECTURE_THESAURUS
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Features Block -->
            <div class="brutalist-block features-block">
                <div class="features-grid">
                    <div class="feature-item">
                        <span class="feature-icon">◉</span>
                        <div class="feature-name">Entity Recognition</div>
                        <div class="feature-desc">AI-powered identification of persons, organizations, and places</div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">◎</span>
                        <div class="feature-name">Authority Linking</div>
                        <div class="feature-desc">Reconciliation with authoritative linked data sources</div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">◐</span>
                        <div class="feature-name">Quality Scoring</div>
                        <div class="feature-desc">Confidence metrics for automated validation workflows</div>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">◑</span>
                        <div class="feature-name">Batch Processing</div>
                        <div class="feature-desc">High-throughput processing for large metadata collections</div>
                    </div>
                </div>
            </div>
            
            <!-- Controls Block -->
            <div class="brutalist-block controls-block">
                <div class="control-group">
                    <button type="submit" class="brutalist-btn">Execute Process</button>
                    <button type="button" class="brutalist-btn secondary" onclick="resetForm()">Reset Parameters</button>
                </div>
                <div class="control-group">
                    <span style="font-family: var(--font-mono); font-size: 10px; color: var(--system-gray);">
                        LAST_MODIFIED: <span id="timestamp">--:--:--</span>
                    </span>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    // File upload handling with enhanced auto-recognition
    document.getElementById('file-input').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        const uploadZone = document.querySelector('.upload-zone');
        
        if (file) {
            uploadZone.classList.add('active');
            uploadZone.innerHTML = `
                <span class="upload-icon">▣</span>
                <div class="upload-text">FILE_LOADED: ${file.name}</div>
                <div class="upload-hint">SIZE: ${(file.size / 1024 / 1024).toFixed(2)}MB</div>
            `;
            
            // Enhanced column detection
            await analyzeFileColumns(file);
        }
    });
    
    // Enhanced file analysis with better auto-recognition
    async function analyzeFileColumns(file) {
        try {
            let text;
            if (file.name.endsWith('.csv')) {
                text = await file.text();
            } else {
                // For Excel files, just show basic message
                showColumnStatus('entity-status', 'Excel file detected - columns will be auto-detected on upload');
                return;
            }
            
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length === 0) return;
            
            // Parse headers
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            // Update column dropdowns
            updateColumnOptions(headers);
            
            // Intelligent column recognition
            const suggestions = suggestColumns(headers);
            showColumnSuggestions(suggestions);
            
        } catch (error) {
            console.error('Error analyzing file:', error);
            showColumnStatus('entity-status', 'Error reading file - please verify format');
        }
    }
    
    // Update dropdown options with detected columns
    function updateColumnOptions(headers) {
        const entitySelect = document.getElementById('entity_column');
        const typeSelect = document.getElementById('type_column');
        
        // Clear existing dynamic options (keep defaults)
        const entityDefaults = ['creator_name', 'author', 'artist', 'name', 'title'];
        const typeDefaults = ['entity_type', 'type', 'category'];
        
        // Remove old dynamic options
        Array.from(entitySelect.options).forEach(option => {
            if (!entityDefaults.includes(option.value) && option.value !== '') {
                option.remove();
            }
        });
        
        Array.from(typeSelect.options).forEach(option => {
            if (!typeDefaults.includes(option.value) && option.value !== '') {
                option.remove();
            }
        });
        
        // Add detected headers
        headers.forEach(header => {
            if (!entityDefaults.includes(header)) {
                const entityOption = new Option(header, header);
                entitySelect.appendChild(entityOption);
            }
            
            if (!typeDefaults.includes(header)) {
                const typeOption = new Option(header, header);
                typeSelect.appendChild(typeOption);
            }
        });
    }
    
    // Intelligent column suggestion based on header names
    function suggestColumns(headers) {
        const suggestions = {
            entity: null,
            type: null,
            context: []
        };
        
        // Entity column patterns (persons, orgs, places)
        const entityPatterns = [
            /^(creator|author|artist|name|person|artist_name|creator_name|author_name)$/i,
            /^(organization|org|institution|publisher|company)$/i,
            /^(place|location|geographic|geo|country|city|birth_place)$/i,
            /^(subject|topic|heading|keyword)$/i
        ];
        
        // Type column patterns
        const typePatterns = [
            /^(type|entity_type|category|classification|kind)$/i,
            /^(role|function|occupation|job_title)$/i
        ];
        
        // Context column patterns
        const contextPatterns = [
            /^(date|year|created|born|died|birth|death|time)$/i,
            /^(place|location|geo|country|city|address)$/i,
            /^(description|bio|biography|note|abstract)$/i,
            /^(nationality|culture|origin|ethnicity)$/i
        ];
        
        headers.forEach(header => {
            const headerLower = header.toLowerCase().trim();
            
            // Check for entity column
            if (!suggestions.entity && entityPatterns.some(pattern => pattern.test(headerLower))) {
                suggestions.entity = header;
            }
            
            // Check for type column
            if (!suggestions.type && typePatterns.some(pattern => pattern.test(headerLower))) {
                suggestions.type = header;
            }
            
            // Check for context columns
            if (contextPatterns.some(pattern => pattern.test(headerLower))) {
                suggestions.context.push(header);
            }
        });
        
        return suggestions;
    }
    
    // Show column suggestions to user
    function showColumnSuggestions(suggestions) {
        if (suggestions.entity) {
            document.getElementById('entity_column').value = suggestions.entity;
            showColumnStatus('entity-status', `AUTO_DETECTED: ${suggestions.entity}`);
        } else {
            showColumnStatus('entity-status', 'No obvious entity column detected - please select manually');
        }
        
        if (suggestions.type) {
            document.getElementById('type_column').value = suggestions.type;
            showColumnStatus('type-status', `AUTO_DETECTED: ${suggestions.type}`);
        }
        
        if (suggestions.context.length > 0) {
            document.getElementById('context_columns').value = suggestions.context.join(',');
            showColumnStatus('context-status', `AUTO_DETECTED: ${suggestions.context.length} context columns`);
        }
    }
    
    // Show status message for column detection
    function showColumnStatus(elementId, message) {
        const statusElement = document.getElementById(elementId);
        statusElement.textContent = message;
        statusElement.classList.remove('hidden');
    }
    
    // Form validation
    document.getElementById('upload-form').addEventListener('submit', function(e) {
        const fileInput = document.getElementById('file-input');
        const entityColumn = document.getElementById('entity_column').value;
        
        console.log('Form submission - File input:', fileInput);
        console.log('Form submission - Files:', fileInput.files);
        console.log('Form submission - Entity column:', entityColumn);
        
        if (!fileInput.files[0]) {
            e.preventDefault();
            alert('ERROR: NO_FILE_SELECTED\n\nPlease select a CSV file to upload.');
            return;
        }
        
        if (!entityColumn.trim()) {
            e.preventDefault();
            alert('ERROR: ENTITY_COLUMN_REQUIRED\n\nPlease specify which column contains the entities to reconcile.');
            return;
        }
        
        // Show processing indicator
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.textContent = 'PROCESSING...';
        submitBtn.disabled = true;
    });
    
    // Reset form
    function resetForm() {
        document.getElementById('upload-form').reset();
        const uploadZone = document.querySelector('.upload-zone');
        uploadZone.classList.remove('active');
        uploadZone.innerHTML = `
            <span class="upload-icon">▦</span>
            <div class="upload-text">Select metadata file</div>
            <div class="upload-hint">CSV, XLSX • MAX 50MB</div>
        `;
        
        // Hide all status messages
        document.querySelectorAll('.column-status').forEach(status => {
            status.classList.add('hidden');
        });
    }
    
    // Update timestamp
    function updateTimestamp() {
        const now = new Date();
        const timestamp = now.toLocaleTimeString('en-US', { hour12: false });
        document.getElementById('timestamp').textContent = timestamp;
    }
    
    updateTimestamp();
    setInterval(updateTimestamp, 1000);
    
    // Check system status periodically
    function checkSystemStatus() {
        fetch('/api/system_status')
            .then(response => response.json())
            .then(data => {
                // Update queue count if available
                if (data.queue_count !== undefined) {
                    document.getElementById('queue-count').textContent = data.queue_count;
                }
            })
            .catch(error => console.error('Status check failed:', error));
    }
    
    // Check status every 30 seconds
    setInterval(checkSystemStatus, 30000);
</script>
{% endblock %}