{% extends "base.html" %}

{% block title %}Export Results - {{ job.filename }}{% endblock %}

{% block content %}
<div class="card">
    <h1>Export Results: {{ job.filename }}</h1>
    <p>Download your reconciled metadata in various formats.</p>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ job.total_entities }}</div>
            <div class="stat-label">Total Entities</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ job.successful_matches }}</div>
            <div class="stat-label">Approved Matches</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ "{:.1f}".format((job.successful_matches / job.total_entities * 100) if job.total_entities > 0 else 0) }}%</div>
            <div class="stat-label">Match Rate</div>
        </div>
    </div>
</div>

<div class="card">
    <h2>Export Options</h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
        <!-- Enhanced CSV Export -->
        <div class="export-option">
            <h3>üìä Enhanced CSV</h3>
            <p>Original data with additional URI and authority information columns.</p>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="include_confidence" checked> Include confidence scores
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="include_sources" checked> Include source authorities
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="include_unmatched" checked> Include unmatched entities
                </label>
            </div>
            
            <button onclick="exportCSV()" class="btn btn-primary" style="width: 100%;">
                <a href="{{ url_for('download_results', job_id=job.id, format='csv') }}" style="color: white; text-decoration: none;">
                    Download Enhanced CSV
                </a>
            </button>
        </div>
        
        <!-- RDF/XML Export -->
        <div class="export-option">
            <h3>üîó RDF/XML</h3>
            <p>Linked data format for semantic web applications and repository ingestion.</p>
            
            <div class="form-group">
                <label for="rdf_namespace">Namespace URI:</label>
                <input type="text" id="rdf_namespace" value="http://example.org/metadata/" 
                       placeholder="http://your-institution.org/metadata/">
                <div class="form-help">Base URI for your metadata records</div>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="include_provenance" checked> Include provenance information
                </label>
            </div>
            
            <button onclick="exportRDF()" class="btn btn-primary" style="width: 100%;">
                <a href="{{ url_for('download_results', job_id=job.id, format='rdf') }}" style="color: white; text-decoration: none;">
                    Download RDF/XML
                </a>
            </button>
        </div>
        
        <!-- JSON-LD Export -->
        <div class="export-option">
            <h3>üåê JSON-LD</h3>
            <p>JSON-based linked data format for web applications and APIs.</p>
            
            <div class="form-group">
                <label for="jsonld_context">Context URL:</label>
                <input type="text" id="jsonld_context" value="http://schema.org/" 
                       placeholder="http://schema.org/">
                <div class="form-help">JSON-LD context for semantic interpretation</div>
            </div>
            
            <button onclick="exportJSONLD()" class="btn btn-primary" style="width: 100%;">
                <a href="{{ url_for('download_results', job_id=job.id, format='json') }}" style="color: white; text-decoration: none;">
                    Download JSON-LD
                </a>
            </button>
        </div>
        
        <!-- Reconciliation Report -->
        <div class="export-option">
            <h3>üìã Reconciliation Report</h3>
            <p>Detailed report of the reconciliation process and quality metrics.</p>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="include_statistics" checked> Include detailed statistics
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="include_failed_matches" checked> Include failed matches analysis
                </label>
            </div>
            
            <button onclick="exportReport()" class="btn btn-primary" style="width: 100%;">
                <a href="{{ url_for('download_results', job_id=job.id, format='report') }}" style="color: white; text-decoration: none;">
                    Download Report (TXT)
                </a>
            </button>
        </div>
        
        <!-- MARC Records -->
        <div class="export-option">
            <h3>üìö MARC Records</h3>
            <p>Library catalog format with authority control fields.</p>
            
            <div class="form-group">
                <label for="marc_format">MARC Format:</label>
                <select id="marc_format">
                    <option value="marc21">MARC 21</option>
                    <option value="marcxml">MARCXML</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="add_authority_fields" checked> Add authority control fields (1xx, 6xx, 7xx)
                </label>
            </div>
            
            <button onclick="exportMARC()" class="btn btn-primary" style="width: 100%;">
                Download MARC Records
            </button>
        </div>
        
        <!-- Custom Export -->
        <div class="export-option">
            <h3>‚öôÔ∏è Custom Export</h3>
            <p>Configure a custom export format with specific fields and structure.</p>
            
            <div class="form-group">
                <label for="custom_format">Output Format:</label>
                <select id="custom_format">
                    <option value="csv">CSV</option>
                    <option value="tsv">Tab-separated</option>
                    <option value="json">JSON</option>
                    <option value="xml">XML</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="custom_fields">Fields to Include:</label>
                <textarea id="custom_fields" rows="4" 
                          placeholder="original_name,matched_uri,confidence_score,source_authority,match_description">original_name,matched_uri,confidence_score,source_authority,match_description</textarea>
                <div class="form-help">Comma-separated list of fields to include</div>
            </div>
            
            <button onclick="exportCustom()" class="btn btn-primary" style="width: 100%;">
                Generate Custom Export
            </button>
        </div>
    </div>
</div>

<div class="card">
    <h2>Batch Actions</h2>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <button onclick="exportAll()" class="btn btn-secondary">
            üì¶ Download All Formats (ZIP)
        </button>
        <a href="{{ url_for('review', job_id=job.id) }}" class="btn btn-secondary">
            ‚Üê Back to Review
        </a>
        <a href="{{ url_for('jobs_list') }}" class="btn btn-secondary">
            üìã View All Jobs
        </a>
    </div>
</div>

<!-- Progress Modal -->
<div id="export-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; min-width: 400px;">
        <h3 id="export-title">Preparing Export...</h3>
        <div class="progress">
            <div class="progress-bar" id="export-progress" style="width: 0%;"></div>
        </div>
        <div class="progress-text" id="export-status">Initializing...</div>
        <div style="text-align: center; margin-top: 1rem;">
            <button onclick="cancelExport()" class="btn btn-secondary" id="cancel-btn">Cancel</button>
        </div>
    </div>
</div>

<style>
.export-option {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1.5rem;
    background: #f8f9fa;
}

.export-option h3 {
    margin-bottom: 1rem;
    color: #2c3e50;
}

.export-option p {
    color: #666;
    margin-bottom: 1rem;
    font-size: 0.9rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.form-group input[type="checkbox"] {
    margin-right: 0.5rem;
}

.form-help {
    font-size: 0.8rem;
    color: #666;
    margin-top: 0.25rem;
}

input[type="text"], select, textarea {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
}

textarea {
    resize: vertical;
    font-family: monospace;
    font-size: 0.9rem;
}
</style>
{% endblock %}

{% block scripts %}
<script>
let currentExportRequest = null;

function exportCSV() {
    window.location.href = "{{ url_for('download_results', job_id=job.id, format='csv') }}";
}

function exportRDF() {
    window.location.href = "{{ url_for('download_results', job_id=job.id, format='rdf') }}";
}

function exportJSON() {
    window.location.href = "{{ url_for('download_results', job_id=job.id, format='json') }}";
}

function exportReport() {
    // Just navigate directly to the download URL
    window.location.href = "{{ url_for('download_results', job_id=job.id, format='report') }}";
}

function showSuccessMessage(message) {
    const successDiv = document.createElement('div');
    successDiv.innerHTML = `
    <div style="position: fixed; top: 20px; right: 20px; background: #d4edda; color: #155724; padding: 1rem; border-radius: 8px; border: 1px solid #c3e6cb; z-index: 1001; max-width: 400px;">
        <strong>Success!</strong><br>
        ${message}
    </div>
    `;
    document.body.appendChild(successDiv);
    
    setTimeout(() => successDiv.remove(), 5000);
}

function cancelExport() {
    if (currentExportRequest) {
        currentExportRequest.abort();
        currentExportRequest = null;
    }
    closeExportModal();
}

function closeExportModal() {
    document.getElementById('export-modal').style.display = 'none';
}
</script>
{% endblock %}