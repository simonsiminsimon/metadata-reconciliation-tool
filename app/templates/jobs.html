{% extends "base.html" %}

{% block title %}Job Management Module - Metadata Reconciliation System{% endblock %}

{% block content %}
<style>
    /* Import brutalist fonts */
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@300;400;500;600;700&display=swap');
    
    :root {
        /* Brutalist Color System */
        --primary-white: #FAFAFA;
        --structure-black: #1A1A1A;
        --accent-blue: #0066FF;
        --system-gray: #808080;
        --success-green: #00CC44;
        --warning-orange: #FF8800;
        --error-red: #FF3333;
        
        /* Brutalist Grid */
        --grid-gap: 16px;
        --border-width: 2px;
        --shadow-offset: 4px;
        
        /* Typography */
        --font-mono: 'JetBrains Mono', monospace;
        --font-sans: 'Inter', sans-serif;
    }
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: var(--font-sans);
        background: var(--primary-white);
        color: var(--structure-black);
        line-height: 1.4;
        min-height: 100vh;
    }
    
    /* Reset base styles for brutalist override */
    .card { display: none; }
    
    .brutalist-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: var(--grid-gap);
        min-height: 100vh;
        background: var(--primary-white);
    }
    
    /* Main Jobs Grid Layout */
    .jobs-bento-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        grid-template-rows: auto;
        gap: var(--grid-gap);
        grid-template-areas:
            "header header header header header header metrics metrics metrics metrics metrics metrics"
            "controls controls controls controls controls controls filters filters filters filters filters filters"
            "jobs jobs jobs jobs jobs jobs jobs jobs jobs jobs jobs jobs"
            "pagination pagination pagination pagination pagination pagination pagination pagination pagination pagination pagination pagination";
    }
    
    /* Brutalist Block Foundation */
    .brutalist-block {
        background: var(--primary-white);
        border: var(--border-width) solid var(--structure-black);
        position: relative;
        transition: all 0.2s ease;
        padding: 24px;
    }
    
    .brutalist-block::before {
        content: '';
        position: absolute;
        top: var(--shadow-offset);
        left: var(--shadow-offset);
        right: calc(-1 * var(--shadow-offset));
        bottom: calc(-1 * var(--shadow-offset));
        background: var(--structure-black);
        z-index: -1;
    }
    
    .brutalist-block:hover::before {
        background: var(--accent-blue);
    }
    
    /* Header Block */
    .header-block {
        grid-area: header;
    }
    
    .system-title {
        font-family: var(--font-mono);
        font-size: clamp(24px, 5vw, 32px);
        font-weight: 700;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: var(--structure-black);
    }
    
    .body-text {
        font-family: var(--font-sans);
        font-size: 14px;
        color: var(--system-gray);
        margin-bottom: 0;
        line-height: 1.4;
    }
    
    /* Metrics Block */
    .metrics-block {
        grid-area: metrics;
    }
    
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-top: 16px;
    }
    
    .metric-card {
        background: var(--structure-black);
        color: var(--primary-white);
        padding: 16px;
        text-align: center;
        position: relative;
        border: var(--border-width) solid var(--structure-black);
    }
    
    .metric-card::before {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        right: -3px;
        bottom: -3px;
        background: var(--accent-blue);
        z-index: -1;
    }
    
    .metric-card.success::before { background: var(--success-green); }
    .metric-card.warning::before { background: var(--warning-orange); }
    .metric-card.error::before { background: var(--error-red); }
    
    .metric-value {
        font-family: var(--font-mono);
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 4px;
        color: var(--primary-white);
    }
    
    .metric-label {
        font-family: var(--font-mono);
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        opacity: 0.9;
    }
    
    /* Controls Block */
    .controls-block {
        grid-area: controls;
        display: flex;
        align-items: center;
        gap: var(--grid-gap);
    }
    
    .view-toggle {
        display: flex;
        gap: 2px;
        border: var(--border-width) solid var(--structure-black);
    }
    
    .view-btn {
        width: 48px;
        height: 48px;
        background: var(--primary-white);
        border: none;
        font-family: var(--font-mono);
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--structure-black);
        transition: all 0.1s ease;
        position: relative;
    }
    
    .view-btn.active {
        background: var(--structure-black);
        color: var(--primary-white);
    }

    .view-btn.active::before {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        right: -2px;
        bottom: -2px;
        background: var(--accent-blue);
        z-index: -1;
    }
    
    /* Bulk Operations Toggle */
    .bulk-toggle {
        background: var(--system-gray);
        color: var(--primary-white);
        border: none;
        padding: 12px 16px;
        font-family: var(--font-mono);
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        cursor: pointer;
        position: relative;
    }
    
    .bulk-toggle::before {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        right: -3px;
        bottom: -3px;
        background: var(--structure-black);
        z-index: -1;
    }
    
    .bulk-toggle.active {
        background: var(--accent-blue);
    }
    
    /* Filters Block */
    .filters-block {
        grid-area: filters;
    }
    
    .filters-grid {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr auto;
        gap: 12px;
        align-items: end;
    }
    
    .field-group {
        display: flex;
        flex-direction: column;
    }
    
    .field-label {
        font-family: var(--font-mono);
        font-size: 10px;
        font-weight: 600;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--structure-black);
    }
    
    .field-input, .field-select {
        padding: 12px;
        border: var(--border-width) solid var(--structure-black);
        background: var(--primary-white);
        font-family: var(--font-sans);
        font-size: 14px;
        font-weight: 400;
    }
    
    .field-input:focus, .field-select:focus {
        outline: none;
        border-color: var(--accent-blue);
    }
    
    /* Brutalist Buttons */
    .brutalist-btn {
        background: var(--structure-black);
        color: var(--primary-white);
        border: none;
        padding: 12px 16px;
        font-family: var(--font-mono);
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        cursor: pointer;
        position: relative;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        transition: all 0.1s ease;
    }
    
    .brutalist-btn::before {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        right: -3px;
        bottom: -3px;
        background: var(--system-gray);
        z-index: -1;
        transition: all 0.1s ease;
    }
    
    .brutalist-btn:hover::before {
        top: 2px;
        left: 2px;
        right: -2px;
        bottom: -2px;
        background: var(--accent-blue);
    }
    
    .brutalist-btn:active {
        transform: translate(2px, 2px);
    }
    
    .brutalist-btn:active::before {
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }
    
    .brutalist-btn.secondary {
        background: var(--primary-white);
        color: var(--structure-black);
        border: var(--border-width) solid var(--structure-black);
    }
    
    .brutalist-btn.success { background: var(--success-green); }
    .brutalist-btn.warning { background: var(--warning-orange); }
    .brutalist-btn.error { background: var(--error-red); }
    
    /* Jobs Container */
    .jobs-container {
        grid-area: jobs;
    }
    
    .bulk-operations {
        background: rgba(26, 26, 26, 0.05);
        padding: 20px;
        border: 2px dashed var(--system-gray);
        margin-bottom: var(--grid-gap);
        display: none;
        position: relative;
    }
    
    .bulk-operations.show {
        display: block;
        animation: slideDown 0.3s ease;
    }
    
    .bulk-header {
        font-family: var(--font-mono);
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 16px;
        color: var(--structure-black);
    }
    
    .bulk-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    /* Job Grid/List Views */
    .jobs-grid {
        display: grid;
        gap: var(--grid-gap);
    }
    
    .jobs-grid.list-view {
        grid-template-columns: 1fr;
    }
    
    .jobs-grid.grid-view {
        grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
    }
    
    /* Job Cards */
    .job-card {
        border: var(--border-width) solid var(--structure-black);
        background: var(--primary-white);
        position: relative;
        transition: all 0.2s ease;
        overflow: hidden;
        padding: 20px;
        cursor: pointer;
    }
    
    .job-card::before {
        content: '';
        position: absolute;
        top: var(--shadow-offset);
        left: var(--shadow-offset);
        right: calc(-1 * var(--shadow-offset));
        bottom: calc(-1 * var(--shadow-offset));
        background: var(--system-gray);
        z-index: -1;
        transition: all 0.2s ease;
    }
    
    .job-card:hover::before {
        background: var(--accent-blue);
        transform: translate(-2px, -2px);
    }
    
    .job-card.status-completed::before { background: var(--success-green); }
    .job-card.status-failed::before { background: var(--error-red); }
    .job-card.status-processing::before { background: var(--warning-orange); }
    
    .job-card.selected {
        background: rgba(0, 102, 255, 0.1);
    }
    
    .job-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 16px;
    }
    
    .job-select {
        margin-right: 12px;
        transform: scale(1.2);
    }
    
    .job-filename {
        font-family: var(--font-mono);
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 4px;
        color: var(--structure-black);
        word-break: break-all;
    }
    
    .job-id {
        font-family: var(--font-mono);
        font-size: 10px;
        color: var(--system-gray);
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .job-status {
        font-family: var(--font-mono);
        font-size: 10px;
        font-weight: 600;
        padding: 4px 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
        border: 1px solid var(--structure-black);
    }
    
    .job-status.completed { background: var(--success-green); color: var(--primary-white); }
    .job-status.failed { background: var(--error-red); color: var(--primary-white); }
    .job-status.processing { background: var(--warning-orange); color: var(--primary-white); }
    .job-status.pending { background: var(--system-gray); color: var(--primary-white); }
    
    .job-metrics {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin: 16px 0;
    }
    
    .job-metric {
        text-align: center;
        padding: 8px;
        border: 1px solid var(--system-gray);
    }
    
    .metric-number {
        font-family: var(--font-mono);
        font-size: 18px;
        font-weight: 700;
        color: var(--structure-black);
    }
    
    .metric-text {
        font-family: var(--font-mono);
        font-size: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--system-gray);
        margin-top: 2px;
    }
    
    .job-progress {
        margin: 16px 0;
    }
    
    .progress-bar {
        width: 100%;
        height: 8px;
        background: var(--system-gray);
        border: 1px solid var(--structure-black);
        position: relative;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: var(--accent-blue);
        transition: width 0.3s ease;
    }
    
    .progress-text {
        font-family: var(--font-mono);
        font-size: 10px;
        margin-top: 4px;
        color: var(--system-gray);
    }
    
    .job-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 16px;
    }
    
    .job-btn {
        padding: 8px 12px;
        font-size: 9px;
        min-width: auto;
        flex: 1;
    }
    
    .job-timestamp {
        font-family: var(--font-mono);
        font-size: 10px;
        color: var(--system-gray);
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--system-gray);
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 80px 20px;
        border: 2px dashed var(--system-gray);
        background: rgba(128, 128, 128, 0.05);
    }
    
    .empty-icon {
        font-family: var(--font-mono);
        font-size: 48px;
        margin-bottom: 16px;
        color: var(--system-gray);
    }
    
    .empty-title {
        font-family: var(--font-mono);
        font-size: 18px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
        color: var(--structure-black);
    }
    
    .empty-text {
        font-size: 14px;
        color: var(--system-gray);
        margin-bottom: 24px;
    }
    
    /* Pagination Block */
    .pagination-block {
        grid-area: pagination;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .pagination-info {
        font-family: var(--font-mono);
        font-size: 12px;
        color: var(--system-gray);
    }
    
    .pagination-controls {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .pagination-btn {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }
    
    /* Animations */
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Responsive Design */
    @media (max-width: 1024px) {
        .jobs-bento-grid {
            grid-template-areas:
                "header header header header header header header header header header header header"
                "metrics metrics metrics metrics metrics metrics metrics metrics metrics metrics metrics metrics"
                "controls controls controls controls controls controls filters filters filters filters filters filters"
                "jobs jobs jobs jobs jobs jobs jobs jobs jobs jobs jobs jobs"
                "pagination pagination pagination pagination pagination pagination pagination pagination pagination pagination pagination pagination";
        }
        
        .metrics-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .filters-grid {
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .jobs-grid.grid-view {
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }
    }
    
    @media (max-width: 768px) {
        .jobs-bento-grid {
            grid-template-columns: repeat(6, 1fr);
            grid-template-areas:
                "header header header header header header"
                "metrics metrics metrics metrics metrics metrics"
                "controls controls controls controls controls controls"
                "filters filters filters filters filters filters"
                "jobs jobs jobs jobs jobs jobs"
                "pagination pagination pagination pagination pagination pagination";
        }
        
        .metrics-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .filters-grid {
            grid-template-columns: 1fr;
        }
        
        .controls-block {
            flex-direction: column;
            align-items: stretch;
        }
        
        .job-actions {
            flex-direction: column;
        }
        
        .job-btn {
            text-align: center;
            width: 100%;
        }
        
        .job-metrics {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 480px) {
        .system-title {
            font-size: 20px;
        }
        
        .job-filename {
            font-size: 14px;
        }
        
        .metrics-grid {
            grid-template-columns: 1fr;
        }
        
        .job-metrics {
            grid-template-columns: 1fr;
        }
    }
    
    /* High contrast mode */
    @media (prefers-contrast: high) {
        :root {
            --primary-white: #FFFFFF;
            --structure-black: #000000;
            --system-gray: #666666;
            --accent-blue: #0033CC;
        }
    }
    
    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
        * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
    }
</style>

<div class="brutalist-container">
    <div class="jobs-bento-grid">
        <!-- Header Block -->
        <div class="brutalist-block header-block">
            <h1 class="system-title">Job Management Module</h1>
            <p class="body-text">Monitor and manage metadata reconciliation processing jobs across the system infrastructure.</p>
        </div>
        
        <!-- Metrics Block -->
        <div class="brutalist-block metrics-block">
            <h2 class="field-label">System Metrics</h2>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="total-jobs">{{ jobs | length }}</div>
                    <div class="metric-label">Total Jobs</div>
                </div>
                <div class="metric-card warning">
                    <div class="metric-value" id="active-jobs">{{ jobs | selectattr('status', 'equalto', 'processing') | list | length }}</div>
                    <div class="metric-label">Processing</div>
                </div>
                <div class="metric-card success">
                    <div class="metric-value" id="completed-jobs">{{ jobs | selectattr('status', 'equalto', 'completed') | list | length }}</div>
                    <div class="metric-label">Completed</div>
                </div>
                <div class="metric-card error">
                    <div class="metric-value" id="failed-jobs">{{ jobs | selectattr('status', 'equalto', 'failed') | list | length }}</div>
                    <div class="metric-label">Failed</div>
                </div>
            </div>
        </div>
        
        <!-- Controls Block -->
        <div class="brutalist-block controls-block">
            <div class="view-toggle">
                <button class="view-btn active" data-view="grid" onclick="setView('grid')" aria-label="Grid View">
                    <span>⊞</span>
                </button>
                <button class="view-btn" data-view="list" onclick="setView('list')" aria-label="List View">
                    <span>☰</span>
                </button>
            </div>
            
            <button class="brutalist-btn bulk-toggle" onclick="toggleBulkOperations()" id="bulk-toggle">
                BULK OPERATIONS
            </button>
            
            <button class="brutalist-btn success" onclick="location.href='/upload'">
                NEW JOB
            </button>
            
            <button class="brutalist-btn secondary" onclick="refreshJobs()">
                REFRESH
            </button>
        </div>
        
        <!-- Filters Block -->
        <div class="brutalist-block filters-block">
            <h2 class="field-label">Filter & Search</h2>
            <div class="filters-grid">
                <div class="field-group">
                    <label class="field-label">Search Jobs</label>
                    <input type="text" class="field-input" id="job-search" placeholder="Search by filename or job ID" onkeyup="filterJobs()">
                </div>
                
                <div class="field-group">
                    <label class="field-label">Status Filter</label>
                    <select class="field-select" id="status-filter" onchange="filterJobs()">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                        <option value="completed">Completed</option>
                        <option value="failed">Failed</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label class="field-label">Sort By</label>
                    <select class="field-select" id="sort-select" onchange="sortJobs()">
                        <option value="created_desc">Newest First</option>
                        <option value="created_asc">Oldest First</option>
                        <option value="filename_asc">Filename A-Z</option>
                        <option value="filename_desc">Filename Z-A</option>
                        <option value="status_asc">Status</option>
                    </select>
                </div>
                
                <button class="brutalist-btn secondary" onclick="clearFilters()">
                    CLEAR
                </button>
            </div>
        </div>
        
        <!-- Jobs Container -->
        <div class="brutalist-block jobs-container">
            <!-- Bulk Operations Panel -->
            <div class="bulk-operations" id="bulk-operations">
                <div class="bulk-header">
                    <span id="selected-count">0</span> JOBS SELECTED
                </div>
                <div class="bulk-actions">
                    <button class="brutalist-btn error" onclick="deleteSelectedJobs()">DELETE SELECTED</button>
                    <button class="brutalist-btn warning" onclick="retrySelectedJobs()">RETRY SELECTED</button>
                    <button class="brutalist-btn secondary" onclick="exportSelectedJobs()">EXPORT SELECTED</button>
                    <button class="brutalist-btn secondary" onclick="clearSelection()">CLEAR SELECTION</button>
                </div>
            </div>
            
            <!-- Jobs Grid -->
            <div class="jobs-grid grid-view" id="jobs-grid">
                {% if jobs %}
                    {% for job in jobs %}
                    <div class="job-card status-{{ job.status }}" 
                         data-job-id="{{ job.id }}" 
                         data-filename="{{ job.filename }}" 
                         data-status="{{ job.status }}"
                         data-created="{{ job.created_at }}">
                        
                        <div class="job-header">
                            <div style="display: flex; align-items: start;">
                                <input type="checkbox" class="job-select" value="{{ job.id }}" onchange="updateSelection()">
                                <div>
                                    <div class="job-filename">{{ job.filename }}</div>
                                    <div class="job-id">JOB_{{ job.id }}</div>
                                </div>
                            </div>
                            <div class="job-status {{ job.status }}">{{ job.status.upper() }}</div>
                        </div>
                        
                        <div class="job-metrics">
                            <div class="job-metric">
                                <div class="metric-number">{{ job.total_records or 0 }}</div>
                                <div class="metric-text">Records</div>
                            </div>
                            <div class="job-metric">
                                <div class="metric-number">{{ job.matched_records or 0 }}</div>
                                <div class="metric-text">Matched</div>
                            </div>
                            <div class="job-metric">
                                <div class="metric-number">{{ job.failed_records or 0 }}</div>
                                <div class="metric-text">Failed</div>
                            </div>
                            <div class="job-metric">
                                <div class="metric-number">{{ ((job.matched_records or 0) / (job.total_records or 1) * 100) | round(1) }}%</div>
                                <div class="metric-text">Success</div>
                            </div>
                        </div>
                        
                        {% if job.status == 'processing' %}
                        <div class="job-progress">
                            <div class="progress-bar">
                            <!-- <div class="progress-fill" style="width: {{ (job.progress or 0)|float|round(1) }}%"></div> -->
                                <div class="progress-fill" id="progress-{{ job.id }}"></div>
                                    <script>
                                    document.getElementById('progress-{{ job.id }}').style.width = '{{ (job.progress or 0)|float|round(1) }}%';
                                    </script>
                            </div>
                            <div class="progress-text">{{ job.progress or 0 }}% Complete</div>
                        </div>
                        {% endif %}
                        
                        <div class="job-actions">
                            {% if job.status == 'completed' %}
                                <a href="{{ url_for('export_job', job_id=job.id) }}" class="brutalist-btn job-btn success">EXPORT</a>
                                <a href="{{ url_for('review_job', job_id=job.id) }}" class="brutalist-btn job-btn secondary">REVIEW</a>
                            {% elif job.status == 'failed' %}
                                <button class="brutalist-btn job-btn warning" onclick="retryJob('{{ job.id }}')">RETRY</button>
                                <button class="brutalist-btn job-btn secondary" onclick="viewLogs('{{ job.id }}')">LOGS</button>
                            {% elif job.status == 'processing' %}
                                <a href="{{ url_for('processing', job_id=job.id) }}" class="brutalist-btn job-btn">VIEW</a>
                                <button class="brutalist-btn job-btn warning" onclick="cancelJob('{{ job.id }}')">CANCEL</button>
                            {% else %}
                                <button class="brutalist-btn job-btn" onclick="startJob('{{ job.id }}')">START</button>
                            {% endif %}
                            <button class="brutalist-btn job-btn error" onclick="deleteJob('{{ job.id }}')">DELETE</button>
                        </div>
                        
                        <div class="job-timestamp">
                            Created: {{ job.created_at.strftime('%Y-%m-%d %H:%M:%S') if job.created_at else 'Unknown' }}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">⚙</div>
                        <div class="empty-title">No Jobs Found</div>
                        <div class="empty-text">Start by uploading a metadata file to create your first reconciliation job.</div>
                        <a href="{{ url_for('upload') }}" class="brutalist-btn">CREATE FIRST JOB</a>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Pagination Block -->
        <div class="brutalist-block pagination-block">
            <div class="pagination-info">
                Showing <span id="jobs-start">1</span>-<span id="jobs-end">{{ jobs | length }}</span> of <span id="jobs-total">{{ jobs | length }}</span> jobs
            </div>
            <div class="pagination-controls">
                <button class="brutalist-btn pagination-btn" onclick="previousPage()" id="prev-btn">‹</button>
                <span class="pagination-info">Page <span id="current-page">1</span></span>
                <button class="brutalist-btn pagination-btn" onclick="nextPage()" id="next-btn">›</button>
            </div>
        </div>
    </div>
</div>

<script>
    class JobsManager {
        constructor() {
            this.currentView = localStorage.getItem('jobsView') || 'grid';
            this.selectedJobs = new Set();
            this.currentPage = 1;
            this.itemsPerPage = 20;
            
            this.initializeView();
            this.setupEventListeners();
            this.setupKeyboardShortcuts();
            this.startAutoRefresh();
        }
        
        initializeView() {
            this.setView(this.currentView);
            this.updateSelection();
        }
        
        setupEventListeners() {
            // Real-time search
            const searchInput = document.getElementById('job-search');
            if (searchInput) {
                searchInput.addEventListener('input', () => this.filterJobs());
            }
            
            // Checkbox change events
            document.addEventListener('change', (e) => {
                if (e.target.classList.contains('job-select')) {
                    this.updateSelection();
                }
            });
        }
        
        setView(view) {
            const container = document.getElementById('jobs-grid');
            const buttons = document.querySelectorAll('.view-btn');
            
            // Update container class
            container.className = `jobs-grid ${view}-view`;
            
            // Update button states
            buttons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            
            this.currentView = view;
            localStorage.setItem('jobsView', view);
        }
        
        filterJobs() {
            const searchTerm = document.getElementById('job-search').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const jobCards = document.querySelectorAll('.job-card');
            let visibleCount = 0;
            
            jobCards.forEach(card => {
                const filename = card.dataset.filename.toLowerCase();
                const jobId = card.dataset.jobId.toLowerCase();
                const status = card.dataset.status;
                
                const matchesSearch = filename.includes(searchTerm) || jobId.includes(searchTerm);
                const matchesStatus = !statusFilter || status === statusFilter;
                const isVisible = matchesSearch && matchesStatus;
                
                card.style.display = isVisible ? 'block' : 'none';
                if (isVisible) visibleCount++;
            });
            
            this.updateJobCounts(visibleCount);
        }
        
        sortJobs() {
            const sortBy = document.getElementById('sort-select').value;
            const container = document.getElementById('jobs-grid');
            const cards = Array.from(container.querySelectorAll('.job-card'));
            
            cards.sort((a, b) => {
                switch (sortBy) {
                    case 'created_desc':
                        return new Date(b.dataset.created) - new Date(a.dataset.created);
                    case 'created_asc':
                        return new Date(a.dataset.created) - new Date(b.dataset.created);
                    case 'filename_asc':
                        return a.dataset.filename.localeCompare(b.dataset.filename);
                    case 'filename_desc':
                        return b.dataset.filename.localeCompare(a.dataset.filename);
                    case 'status_asc':
                        return a.dataset.status.localeCompare(b.dataset.status);
                    default:
                        return 0;
                }
            });
            
            // Re-append sorted cards
            cards.forEach(card => container.appendChild(card));
        }
        
        clearFilters() {
            document.getElementById('job-search').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('sort-select').value = 'created_desc';
            this.filterJobs();
            this.sortJobs();
        }
        
        updateSelection() {
            const checkboxes = document.querySelectorAll('.job-select');
            const bulkOps = document.getElementById('bulk-operations');
            const selectedCount = document.getElementById('selected-count');
            
            this.selectedJobs.clear();
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    this.selectedJobs.add(cb.value);
                    cb.closest('.job-card').classList.add('selected');
                } else {
                    cb.closest('.job-card').classList.remove('selected');
                }
            });
            
            selectedCount.textContent = this.selectedJobs.size;
            
            if (this.selectedJobs.size > 0) {
                bulkOps.classList.add('show');
            } else {
                bulkOps.classList.remove('show');
            }
        }
        
        selectAllJobs() {
            const checkboxes = document.querySelectorAll('.job-select:not(:disabled)');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
            });
            
            this.updateSelection();
        }
        
        clearSelection() {
            document.querySelectorAll('.job-select').forEach(cb => {
                cb.checked = false;
            });
            this.updateSelection();
        }
        
        toggleBulkOperations() {
            const bulkOps = document.getElementById('bulk-operations');
            const toggle = document.getElementById('bulk-toggle');
            
            bulkOps.classList.toggle('show');
            toggle.classList.toggle('active');
        }
        
        deleteJob(jobId) {
            if (confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
                fetch(`/api/jobs/${jobId}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.querySelector(`[data-job-id="${jobId}"]`).remove();
                            this.updateMetrics();
                        }
                    })
                    .catch(error => console.error('Error deleting job:', error));
            }
        }
        
        deleteSelectedJobs() {
            if (this.selectedJobs.size === 0) return;
            
            if (confirm(`Delete ${this.selectedJobs.size} selected jobs? This action cannot be undone.`)) {
                Promise.all(
                    Array.from(this.selectedJobs).map(jobId =>
                        fetch(`/api/jobs/${jobId}`, { method: 'DELETE' })
                    )
                ).then(() => {
                    this.selectedJobs.forEach(jobId => {
                        document.querySelector(`[data-job-id="${jobId}"]`)?.remove();
                    });
                    this.clearSelection();
                    this.updateMetrics();
                });
            }
        }
        
        retryJob(jobId) {
            fetch(`/api/jobs/${jobId}/retry`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    }
                })
                .catch(error => console.error('Error retrying job:', error));
        }
        
        cancelJob(jobId) {
            if (confirm('Cancel this job?')) {
                fetch(`/api/jobs/${jobId}/cancel`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        }
                    })
                    .catch(error => console.error('Error canceling job:', error));
            }
        }
        
        startJob(jobId) {
            fetch(`/api/jobs/${jobId}/start`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.href = `/processing/${jobId}`;
                    }
                })
                .catch(error => console.error('Error starting job:', error));
        }
        
        refreshJobs() {
            location.reload();
        }
        
        updateMetrics() {
            // Update the metrics counters
            fetch('/api/jobs/metrics')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total-jobs').textContent = data.total;
                    document.getElementById('active-jobs').textContent = data.processing;
                    document.getElementById('completed-jobs').textContent = data.completed;
                    document.getElementById('failed-jobs').textContent = data.failed;
                })
                .catch(error => console.error('Error updating metrics:', error));
        }
        
        startAutoRefresh() {
            setInterval(() => {
                this.updateMetrics();
                
                // Update processing job progress
                document.querySelectorAll('.job-card.status-processing').forEach(card => {
                    const jobId = card.dataset.jobId;
                    fetch(`/api/jobs/${jobId}/progress`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.progress !== undefined) {
                                const progressBar = card.querySelector('.progress-fill');
                                const progressText = card.querySelector('.progress-text');
                                if (progressBar) {
                                    progressBar.style.width = `${data.progress}%`;
                                    progressText.textContent = `${data.progress}% Complete`;
                                }
                            }
                        })
                        .catch(error => console.error('Error updating progress:', error));
                });
            }, 5000); // Update every 5 seconds
        }
        
        setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'a':
                            e.preventDefault();
                            this.selectAllJobs();
                            break;
                        case 'f':
                            e.preventDefault();
                            document.getElementById('job-search').focus();
                            break;
                        case 'r':
                            e.preventDefault();
                            this.refreshJobs();
                            break;
                        case '1':
                            e.preventDefault();
                            this.setView('grid');
                            break;
                        case '2':
                            e.preventDefault();
                            this.setView('list');
                            break;
                    }
                }
            });
        }
        
        updateJobCounts(visibleCount) {
            const totalJobs = document.querySelectorAll('.job-card').length;
            console.log(`📊 Showing ${visibleCount} of ${totalJobs} jobs`);
        }
    }
    
    // Initialize jobs manager
    let jobsManager;
    document.addEventListener('DOMContentLoaded', function() {
        jobsManager = new JobsManager();
    });
    
    // Global functions for template compatibility
    function setView(view) { jobsManager.setView(view); }
    function filterJobs() { jobsManager.filterJobs(); }
    function sortJobs() { jobsManager.sortJobs(); }
    function updateSelection() { jobsManager.updateSelection(); }
    function selectAllJobs() { jobsManager.selectAllJobs(); }
    function clearSelection() { jobsManager.clearSelection(); }
    function deleteJob(jobId) { jobsManager.deleteJob(jobId); }
    function deleteSelectedJobs() { jobsManager.deleteSelectedJobs(); }
    function cancelJob(jobId) { jobsManager.cancelJob(jobId); }
    function retryJob(jobId) { jobsManager.retryJob(jobId); }
    function startJob(jobId) { jobsManager.startJob(jobId); }
    function refreshJobs() { jobsManager.refreshJobs(); }
    function toggleBulkOperations() { jobsManager.toggleBulkOperations(); }
    function clearFilters() { jobsManager.clearFilters(); }
    function viewLogs(jobId) { 
        window.open(`/logs/${jobId}`, '_blank');
    }
    function retrySelectedJobs() {
        if (jobsManager.selectedJobs.size === 0) return;
        
        Promise.all(
            Array.from(jobsManager.selectedJobs).map(jobId =>
                fetch(`/api/jobs/${jobId}/retry`, { method: 'POST' })
            )
        ).then(() => {
            location.reload();
        });
    }
    function exportSelectedJobs() {
        if (jobsManager.selectedJobs.size === 0) return;
        
        const jobIds = Array.from(jobsManager.selectedJobs).join(',');
        window.open(`/export/bulk?jobs=${jobIds}`, '_blank');
    }
</script>
{% endblock %}